<?php

namespace Drupal\weather_data\Service\Test;

use Drupal\Core\StringTranslation\TranslationInterface;
use Drupal\weather_data\Service\WeatherDataService;
use GuzzleHttp\Client;
use GuzzleHttp\Exception\RequestException;
use GuzzleHttp\Handler\MockHandler;
use GuzzleHttp\HandlerStack;
use GuzzleHttp\Psr7\Request;
use GuzzleHttp\Psr7\Response;
use PHPUnit\Framework\ExpectationFailedException;
use PHPUnit\Framework\TestCase;

/**
 * Tests for the WeatherDataService getGridFromLatLon method.
 */
final class WeatherDataServiceGetGridFromLatLon extends Base
{
    /**
     * Tests the happy path.
     */
    public function testHappyPath(): void
    {
        $this->httpClientMock->append(
            new Response(
                200,
                ["Content-type" => "application/geo+json"],
                json_encode([
                    "properties" => [
                        "gridId" => "the wfo",
                        "gridX" => "an x",
                        "gridY" => "a y",
                        "relativeLocation" => [
                            "properties" => [
                                "city" => "place",
                                "state" => "placestate",
                            ],
                        ],
                    ],
                ]),
            ),
        );

        $expected = [
            "wfo" => "the wfo",
            "gridX" => "an x",
            "gridY" => "a y",
            "location" => "place",
        ];

        $actual = $this->weatherDataService->getGridFromLatLon(1, 2);

        $this->assertEquals((object) $expected, (object) $actual);
    }

    /**
     * Tests using the suggested place name when it can't be broken up.
     */
    public function testUsingSuggestedPlaceNameAsOneBlob(): void
    {
        $this->httpClientMock->append(
            new Response(
                200,
                ["Content-type" => "application/geo+json"],
                json_encode([
                    "properties" => [
                        "gridId" => "the wfo",
                        "gridX" => "an x",
                        "gridY" => "a y",
                        "relativeLocation" => [
                            "properties" => [
                                "city" => "place",
                                "state" => "placestate",
                            ],
                        ],
                    ],
                ]),
            ),
        );

        $this->requestMock->method("get")->willReturn("suggested place");

        $expected = [
            "wfo" => "the wfo",
            "gridX" => "an x",
            "gridY" => "a y",
            "location" => "suggested place",
        ];

        $actual = $this->weatherDataService->getGridFromLatLon(1, 2);

        $this->assertEquals((object) $expected, (object) $actual);
    }

    /**
     * Tests using the suggested place name when it can be split up.
     */
    public function testUsingSuggestedPlaceNameAsCityState(): void
    {
        $this->httpClientMock->append(
            new Response(
                200,
                ["Content-type" => "application/geo+json"],
                json_encode([
                    "properties" => [
                        "gridId" => "the wfo",
                        "gridX" => "an x",
                        "gridY" => "a y",
                        "relativeLocation" => [
                            "properties" => [
                                "city" => "place",
                                "state" => "placestate",
                            ],
                        ],
                    ],
                ]),
            ),
        );

        $this->requestMock
            ->method("get")
            ->willReturn("suggested place, ST, USA");

        $expected = [
            "wfo" => "the wfo",
            "gridX" => "an x",
            "gridY" => "a y",
            "location" => "suggested place",
        ];

        $actual = $this->weatherDataService->getGridFromLatLon(1, 2);

        $this->assertEquals((object) $expected, (object) $actual);
    }

    /**
     * Tests when we get a request error.
     */
    public function testErrorCondition(): void
    {
        $this->httpClientMock->append(
            new RequestException("", new Request("GET", "")),
        );

        $actual = $this->weatherDataService->getGridFromLatLon(1, 2);

        $this->assertEquals(null, $actual);
    }
}
