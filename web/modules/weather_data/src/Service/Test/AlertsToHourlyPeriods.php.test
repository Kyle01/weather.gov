<?php

namespace Drupal\weather_data\Service\Test;

final class AlertsToHourlyPeriodsTest extends Base
{
    public static $periods = [
        [
            "timestamp" => "2024-02-26T11:00:00-05:00",
            "endTime" => "2024-02-26T12:00:00-05:00",
        ],
        [
            "timestamp" => "2024-02-26T12:00:00-05:00",
            "endTime" => "2024-02-26T13:00:00-05:00",
        ],
        [
            "timestamp" => "2024-02-26T13:00:00-05:00",
            "endTime" => "2024-02-26T14:00:00-05:00",
        ],
        [
            "timestamp" => "2024-02-26T14:00:00-05:00",
            "endTime" => "2024-02-26T15:00:00-05:00",
        ],
        [
            "timestamp" => "2024-02-26T15:00:00-05:00",
            "endTime" => "2024-02-26T16:00:00-05:00",
        ],
    ];

    /**
     * Test that 3 alerts that start and end
     * at actual period times are correctly
     * aligned
     */
    public function testPerfectlyAligned()
    {
        $alerts = [
            (object) [
                "onsetRaw" => "2024-02-26T11:00:00-05:00",
                "endsRaw" => "2024-02-26T13:00:00-05:00",
                "timezone" => "America/New_York",
            ],
            (object) [
                "onsetRaw" => "2024-02-26T14:00:00-05:00",
                "endsRaw" => "2024-02-26T15:00:00-05:00",
                "timezone" => "America/New_York",
            ],
            (object) [
                "onsetRaw" => "2024-02-26T15:00:00-05:00",
                "endsRaw" => "2024-02-26T16:00:00-05:00",
                "timezone" => "America/New_York",
            ],
        ];

        $expected = [
            [
                "periodIndex" => 0,
                "duration" => 2,
                "alert" => $alerts[0],
            ],
            [
                "periodIndex" => 3,
                "duration" => 1,
                "alert" => $alerts[1],
            ],
            [
                "periodIndex" => 4,
                "duration" => 1,
                "alert" => $alerts[2],
            ],
        ];

        $actual = $this->weatherDataService->alertsToHourlyPeriods(
            $alerts,
            self::$periods,
        );

        $this->assertEquals(3, count($actual));
        $this->assertEquals($expected, $actual);
    }

  /**
   * Test overlapping alert periods
   *
   * In this case, two alerts overlap
   * partially over a given set of periods.
   */
  public function testOverlapping(){
    $alerts = [
      (object)[
        "onsetRaw" => "2024-02-26T12:00:00-05:00",
        "endsRaw" => "2024-02-26T15:00:00-05:00",
        "timezone" => "America/New_York",
      ],
      (object) [
        "onsetRaw" => "2024-02-26T13:00:00-05:00",
        "endsRaw" => "2024-02-26T16:00:00-05:00",
        "timezone" => "America/New_York",
      ],
    ];

    $expected = [
      [
        "periodIndex" => 1,
        "duration" => 3,
        "alert" => $alerts[0],
      ],
      [
        "periodIndex" => 2,
        "duration" => 3,
        "alert" => $alerts[1],
      ]
    ];

    $actual = $this->weatherDataService->alertsToHourlyPeriods(
      $alerts,
      self::$periods
    );
    
    $this->assertEquals($expected[0], $actual[0]);
    $this->assertEquals($expected[1], $actual[1]);
  }
}
